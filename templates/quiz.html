<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¬å†™æµ‹è¯• - {{ lesson_name }} - è¯æ±‡å­¦ä¹ åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .lesson-title {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .progress {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .word-display {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 30px 0;
            min-height: 60px;
        }
        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 4px;
            margin: 10px 5px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-known {
            background-color: #2ecc71;
        }
        .btn-known:hover {
            background-color: #27ae60;
        }
        .btn-unknown {
            background-color: #e74c3c;
        }
        .btn-unknown:hover {
            background-color: #c0392b;
        }
        .btn-speak {
            background-color: #9b59b6;
        }
        .btn-speak:hover {
            background-color: #8e44ad;
        }
        .result-container {
            margin: 30px 0;
        }
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            text-align: left;
        }
        .result-known {
            background-color: #d5f4e6;
            border-left: 4px solid #2ecc71;
        }
        .result-unknown {
            background-color: #fadbd8;
            border-left: 4px solid #e74c3c;
        }
        .hidden {
            display: none;
        }
        .speak-instruction {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœï¸ å¬å†™æµ‹è¯•</h1>
        <div class="lesson-title">{{ lesson_name }} (å…± {{ word_count }} ä¸ªè¯)</div>
        
        <div class="progress">
            å½“å‰è¿›åº¦: <span id="current-index">1</span> / {{ word_count }}
        </div>
        
        <div class="speak-instruction">
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¬è¯æ±‡å‘éŸ³ï¼Œç„¶åå‘Šè¯‰ç³»ç»Ÿæ‚¨æ˜¯å¦èƒ½é»˜å†™å‡ºè¿™ä¸ªè¯ã€‚</p>
        </div>
        
        <div class="word-display" id="word-display">
            {{ current_word }}
        </div>
        
        <div id="quiz-area">
            <button class="btn btn-speak" onclick="speakCurrentWord()">ğŸ”Š æ’­æ”¾å‘éŸ³</button>
            <br>
            <button class="btn btn-known" onclick="recordResult(true)">âœ… æˆ‘èƒ½é»˜å†™</button>
            <button class="btn btn-unknown" onclick="recordResult(false)">âŒ é»˜å†™ä¸å‡º</button>
        </div>
        
        <div id="result-area" class="result-container hidden">
            <h3>æµ‹è¯•å®Œæˆï¼</h3>
            <div id="results-list"></div>
            <a href="{{ url_for('vocab_list') }}" class="btn">è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
        </div>
    </div>

    <script>
        let currentIndex = 0; // ä»0å¼€å§‹è®¡æ•°
        const totalWords = {{ word_count }};
        let currentWord = '{{ current_word|default("") }}';
        
        async function speakCurrentWord() {
            // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„è¯æ±‡ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨JSä¸­çš„currentWordå˜é‡
            const wordDisplay = document.getElementById('word-display').textContent.trim();
            const wordToSpeak = wordDisplay !== '' && wordDisplay !== '(æ‚¨å·²æŒæ¡)' ? wordDisplay : currentWord;
            
            // Play the audio using browser text-to-speech API
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                utterance.lang = 'zh-CN';  // Set language to Chinese
                utterance.rate = 0.8;  // Slower rate for clarity
                utterance.pitch = 1;   // Normal pitch
                speechSynthesis.speak(utterance);
            } else {
                // Fallback to server-side TTS if browser doesn't support it
                try {
                    await fetch(`/speak_word/${encodeURIComponent(wordToSpeak)}`);
                } catch (error) {
                    console.error('Error speaking word:', error);
                    alert('æ’­æ”¾å‘éŸ³æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•');
                }
            }
        }

        async function recordResult(isKnown) {
            const wordDisplay = document.getElementById('word-display');
            const quizArea = document.getElementById('quiz-area');
            
            // Show the word if the user couldn't write it
            if (!isKnown) {
                wordDisplay.textContent = currentWord;
            } else {
                wordDisplay.textContent = '(æ‚¨å·²æŒæ¡)';
            }
            
            // Disable buttons to prevent double submission
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // Prepare form data
            const formData = new FormData();
            formData.append('answer', currentWord);
            formData.append('is_known', isKnown);
            
            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'finished') {
                    // Show results
                    document.getElementById('quiz-area').classList.add('hidden');
                    document.getElementById('result-area').classList.remove('hidden');
                    
                    const resultsList = document.getElementById('results-list');
                    data.results.forEach(result => {
                        const div = document.createElement('div');
                        div.className = `result-item ${result.known ? 'result-known' : 'result-unknown'}`;
                        div.innerHTML = `<strong>${result.word}</strong>: ${result.known ? 'âœ… å·²æŒæ¡' : 'âŒ æœªæŒæ¡'}`;
                        resultsList.appendChild(div);
                    });
                } else if (data.status === 'continue') {
                    // Move to next word
                    currentIndex = data.current_index;
                    document.getElementById('current-index').textContent = currentIndex + 1;
                    
                    // Update the current word variable
                    currentWord = data.next_word;
                    
                    // Update display for next word
                    wordDisplay.textContent = currentWord;
                    
                    // Re-enable buttons
                    document.querySelectorAll('.btn').forEach(btn => {
                        btn.disabled = false;
                    });
                    
                    // Focus back to speak button
                    document.querySelector('.btn-speak').focus();
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('æäº¤ç­”æ¡ˆæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
                
                // Re-enable buttons in case of error
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.disabled = false;
                });
            }
        }
    </script>
</body>
</html>