<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½å¯«æ¸¬è©¦ - {{ lesson_name }} - è©å½™å­¸ç¿’åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .lesson-title {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .progress {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .word-display {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 30px 0;
            min-height: 60px;
        }
        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 4px;
            margin: 10px 5px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-known {
            background-color: #2ecc71;
        }
        .btn-known:hover {
            background-color: #27ae60;
        }
        .btn-unknown {
            background-color: #e74c3c;
        }
        .btn-unknown:hover {
            background-color: #c0392b;
        }
        .btn-speak {
            background-color: #9b59b6;
        }
        .btn-speak:hover {
            background-color: #8e44ad;
        }
        .btn-replay {
            background-color: #3498db;
        }
        .btn-replay:hover {
            background-color: #2980b9;
        }
        .result-container {
            margin: 30px 0;
        }
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            text-align: left;
        }
        .result-known {
            background-color: #d5f4e6;
            border-left: 4px solid #2ecc71;
        }
        .result-unknown {
            background-color: #fadbd8;
            border-left: 4px solid #e74c3c;
        }
        .hidden {
            display: none;
        }
        .speak-instruction {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœï¸ è½å¯«æ¸¬è©¦</h1>
        <div class="lesson-title">{{ lesson_name }} (å…± {{ word_count }} å€‹è©)</div>
        
        <div class="progress">
            ç•¶å‰é€²åº¦: <span id="current-index">1</span> / {{ word_count }}
        </div>
        
        <div class="speak-instruction">
            <p>ğŸ§ ç¾åœ¨é–‹å§‹è½å¯«ã€‚ä»”ç´°è½æ¯ä¸€å€‹è©ï¼Œç„¶å¾Œå‘Šè¨´ç³»çµ±æ‚¨æ˜¯å¦èƒ½é»˜å¯«å‡ºä¾†ã€‚</p>
        </div>
        
        <div class="word-display" id="word-display">
            <em style="color: #95a5a6; font-size: 1.1em;">æº–å‚™å¥½äº†å—ï¼Ÿ2ç§’å¾Œé–‹å§‹è®€ç¬¬ä¸€å€‹è©...</em>
        </div>
        
        <audio id="audio-player" style="display: none;"></audio>
        
        <div id="quiz-area">
            <button class="btn btn-replay" onclick="speakCurrentWord()">ğŸ”Š é‡æ–°è½</button>
            <button class="btn btn-known" onclick="recordResult(true)">âœ… æˆ‘èƒ½é»˜å¯«</button>
            <button class="btn btn-unknown" onclick="recordResult(false)">âŒ é»˜å¯«ä¸å‡º</button>
        </div>
        
        <div id="results-display" class="result-container" style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 8px;">
            <h3>è½å¯«çµæœï¼š</h3>
            <div id="results-list"></div>
        </div>
    </div>

    <script>
        let currentIndex = 0;
        let allWords = {{ words_json|safe }};  // All words as JSON array
        // æ ¹æ®å®é™…çš„allWordsæ•°ç»„é•¿åº¦è®¡ç®—totalWordsï¼Œç¡®ä¿å‡†ç¡®æ€§
        let totalWords = allWords.length;
        let currentWord = allWords[0] || '';
        let testStarted = false;
        let results = [];
        let isProcessing = false;  // Flag to prevent double submission
        
        // Use language and lesson directly from Flask context
        const language = '{{ language }}';
        const lesson = '{{ lesson_num }}';
        const contentType = '{{ content_type }}' || 'è©èª';  // Content type from Flask
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¤ä¹ æ¨¡å¼
        const urlParams = new URLSearchParams(window.location.search);
        const isReviewMode = urlParams.get('review_mode') === 'true';
        
        // å¦‚æœæ˜¯å¤ä¹ æ¨¡å¼ï¼Œä» sessionStorage è¯»å–æœªæŒæ¡å•è¯åˆ—è¡¨
        if (isReviewMode) {
            const reviewWordsStr = sessionStorage.getItem('review_words');
            if (reviewWordsStr) {
                try {
                    const reviewWords = JSON.parse(reviewWordsStr);
                    // è¿‡æ»¤å‡ºåªåŒ…å«æœªæŒæ¡å•è¯çš„åˆ—è¡¨
                    allWords = allWords.filter(word => reviewWords.includes(word));
                    totalWords = allWords.length;
                    currentWord = allWords[0] || '';
                    console.log('Review mode: filtered to', totalWords, 'words');
                } catch (e) {
                    console.error('Error parsing review words:', e);
                }
                // æ¸…é™¤ sessionStorage
                sessionStorage.removeItem('review_words');
            }
        }
        
        console.log('Quiz initialized:', {totalWords, allWords, currentWord, language, lesson, contentType, isReviewMode});
        
        // æ‰€æœ‰éŸ³é¢‘å·²é¢„å…ˆç”Ÿæˆå®Œæ¯•ï¼Œé¡µé¢åŠ è½½å®Œæˆåç«‹å³æ’­æ”¾
        window.addEventListener('load', function() {
            // æ›´æ–°è¿›åº¦æ˜¾ç¤ºä¸­çš„æ€»è¯æ•°ï¼Œç¡®ä¿ä¸å®é™…çš„allWordsæ•°ç»„ä¸€è‡´
            document.querySelectorAll('.lesson-title').forEach(el => {
                el.textContent = el.textContent.replace(/å…±\s*\d+\s*å€‹è©/, `å…± ${totalWords} å€‹è©`);
            });
            document.getElementById('current-index').parentElement.innerHTML = `ç•¶å‰é€²åº¦: <span id="current-index">1</span> / ${totalWords}`;
            
            speakCurrentWord();
            testStarted = true;
        });
        
        function speakCurrentWord() {
            // è°ƒç”¨åç«¯ç«¯ç‚¹è·å–éŸ³é¢‘ URLï¼ˆç«¯ç‚¹ç«‹å³è¿”å›ï¼Œæ— éœ€ç”Ÿæˆï¼‰
            fetch(`/tts/${encodeURIComponent(currentWord)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.url) {
                        playAudio(data.url);
                    }
                })
                .catch(err => console.error('Error:', err));
        }
        
        function playAudio(url) {
            try {
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = url;
                const promise = audioPlayer.play();
                if (promise !== undefined) {
                    promise.catch(err => console.error('Play error:', err));
                }
            } catch (err) {
                console.error('Error playing audio:', err);
            }
        }

        async function recordResult(isKnown) {
            // Prevent duplicate submissions
            if (isProcessing) {
                return;
            }
            isProcessing = true;
            
            const wordDisplay = document.getElementById('word-display');
            
            // Disable buttons to prevent double submission
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // Add result to results list
            const resultsList = document.getElementById('results-list');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-item ${isKnown ? 'result-known' : 'result-unknown'}`;
            resultDiv.innerHTML = `<strong>${currentWord}</strong>: ${isKnown ? 'âœ… å·²æŒæ¡' : 'âŒ æœªæŒæ¡'}`;
            resultsList.appendChild(resultDiv);
            
            // Store result locally
            results.push({word: currentWord, known: isKnown});
            
            try {
                const formData = new FormData();
                formData.append('word', currentWord);
                formData.append('is_known', isKnown);
                formData.append('word_index', currentIndex);
                formData.append('total_words', totalWords);
                formData.append('language', language);
                formData.append('lesson', lesson);
                formData.append('content_type', contentType);
                
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('Response error:', data);
                    alert('éŒ¯èª¤ï¼š' + (data.error || data.debug || 'æäº¤ç­”æ¡ˆå¤±æ•—'));
                    document.querySelectorAll('.btn').forEach(btn => {
                        btn.disabled = false;
                    });
                    isProcessing = false;
                    return;
                }
                
                // Check if this was the last word
                if (currentIndex + 1 >= totalWords) {
                    wordDisplay.innerHTML = '<em style="color: #27ae60; font-size: 1.3em; font-weight: bold;">âœ… è½å¯«æ¸¬è©¦å®Œæˆï¼</em>';
                    document.querySelectorAll('.btn').forEach(btn => {
                        btn.classList.add('hidden');
                    });
                    
                    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                    const knownCount = results.filter(r => r.known).length;
                    const unknownCount = results.filter(r => !r.known).length;
                    const accuracy = totalWords > 0 ? Math.round(knownCount / totalWords * 100) : 0;
                    
                    // æ˜¾ç¤ºå®Œæˆæ‘˜è¦
                    const summaryDiv = document.createElement('div');
                    summaryDiv.style.cssText = 'background-color: #d5f4e6; border-left: 4px solid #27ae60; padding: 20px; border-radius: 4px; margin: 20px 0; text-align: left;';
                    summaryDiv.innerHTML = `
                        <h3 style="margin-top: 0; color: #27ae60;">è½å¯«çµæœæ‘˜è¦</h3>
                        <p><strong>ç¸½å…±è©èªï¼š</strong> ${totalWords} å€‹</p>
                        <p><strong>âœ… èƒ½é»˜å¯«ï¼š</strong> ${knownCount} å€‹</p>
                        <p><strong>âŒ ä¸èƒ½é»˜å¯«ï¼š</strong> ${unknownCount} å€‹</p>
                        <p><strong>æº–ç¢ºç‡ï¼š</strong> ${accuracy}%</p>
                    `;
                    document.getElementById('quiz-area').appendChild(summaryDiv);
                    
                    const finishBtn = document.createElement('button');
                    finishBtn.className = 'btn';
                    finishBtn.style.marginTop = '20px';
                    finishBtn.textContent = 'è¿”å›é¦–é ';
                    finishBtn.onclick = function() {
                        window.location.href = '/vocab_list';
                    };
                    document.getElementById('quiz-area').appendChild(finishBtn);
                    isProcessing = false;
                } else {
                    setTimeout(() => {
                        currentIndex++;
                        if (currentIndex < allWords.length) {
                            currentWord = allWords[currentIndex];
                            
                            document.getElementById('current-index').textContent = currentIndex + 1;
                            speakCurrentWord();
                            wordDisplay.innerHTML = '<em style="color: #95a5a6; font-size: 1.1em;">æ­£åœ¨è®€ç¬¬' + (currentIndex + 1) + 'å€‹è©...</em>';
                            
                            document.querySelectorAll('.btn').forEach(btn => {
                                btn.disabled = false;
                            });
                            
                            isProcessing = false;
                            document.querySelector('.btn-known').focus();
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('æäº¤ç­”æ¡ˆæ™‚å‡ºç¾éŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼š' + error.message);
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.disabled = false;
                });
                isProcessing = false;
            }
        }
    </script>
</body>
</html>